// a card factory ,create 10 cards once a time;
// in this 10 cards, contain 6 cards where rarity is white and 3 green cards and 1 blud card
// 10 cards call one bag, every 10 cards must have one bag which contains 1 purple card, 3 green cards and 6 green cards
// and in 100 bags must have on bag which contains 1 orange card , 3 green cards and 6 white cards.

// 10张卡里6白3绿1蓝，平均每10包出现6白3绿1紫，平均每100包出现6白3绿1橙
// 也就是白：60%，绿：30%，蓝：9%，紫：0.9%，橙: 0.1%
var groups = require('./groups.js').groups;
var total = 0;
//var rarity= {'白':600,'绿':300,'蓝':90,'紫':9,'橙':1};
module.exports = function(){
	//total: 总计, sub 小计
	this.count = {sub:0,白:0,绿:0,蓝:0,紫:0,橙:0};
	this.allCards = {'白':[], '绿':[], '蓝':[], '紫':[], '橙':[]};
	this.init = function(){
		for(var i in groups){
			groups[i].amount = 1;
			this.allCards[groups[i].rarity].push(groups[i]);
		}
	};
	this.create = function(){
		var cards = [];
		total++;
		this.count.sub++;
		for(var i = 0 ; i < 6 ; i++){
			this.pushCard('白', cards);
		}
		for(var i = 0 ; i < 3 ; i++){
			this.pushCard('绿', cards);
		}
		console.log('紫:'+this.count['紫']+' sub:'+this.count.sub);
		while(cards.length < 10){
			var rnd = Math.floor(Math.random()*100+1);
			console.log('rnd:' + rnd + ' total:' + total + ' sub:' + this.count.sub);
			if( ( rnd == 1 || total >= 100 ) &&  this.count['橙'] == 0){
				this.pushCard('橙', cards);
			}else if( this.count['紫'] == 0 && ( (rnd <= 10 && rnd > 1) || ( this.count.sub >= 10 ) )) {
				//one bag contains one purple card, and only one.
				this.pushCard('紫', cards);
			}else{
				//one bag contains 
				this.pushCard('蓝', cards);
			}
		}
		if(this.count.sub >= 10){
			this.count.sub = 0;
			this.count['紫'] = 0;
		}
		if(total >= 100){
			total = 0;
			this.count['橙'] = 0;
		}
		return cards;
	};
	this.pushCard = function(r,cards){
		while(true){
			var index = Math.floor( Math.random() * this.allCards[r].length );
			var card = this.allCards[r][index];
			var isNew = true;
			for(var i in cards){
				if(card.id == cards[i].id)
					isNew = false;
			}
			if(isNew){
				cards.push(card);
				this.count[r]++;
				return;
			}
		}
	};
};